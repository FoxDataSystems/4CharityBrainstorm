{% extends "base.html" %}

{% block content %}
<div class="idea-card">
    <h2>{{ idea.title }}</h2>
    {% if idea.image_path %}
    <img src="{{ url_for('static', filename=idea.image_path) }}" class="idea-image">
    {% endif %}
    
    <div class="idea-metadata">
        <p>Category: {{ idea.category.name }}</p>
        <p>Created by: {{ idea.author.username }}</p>
        <p>Date: {{ idea.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
    </div>

    <div class="idea-content glass-card">
        {{ idea.content }}
    </div>

    {% if current_user.id == idea.user_id %}
    <div class="idea-actions">
        <button onclick="window.location.href='{{ url_for('edit_idea', idea_id=idea.id) }}'">Edit</button>
        <button class="delete-btn" onclick="confirmDelete()">Delete</button>
        <form id="deleteForm" action="{{ url_for('delete_idea', idea_id=idea.id) }}" method="POST" style="display: none;"></form>
    </div>

    <script>
    function confirmDelete() {
        if (confirm('Are you sure you want to delete this idea? This action cannot be undone.')) {
            document.getElementById('deleteForm').submit();
        }
    }
    </script>
    {% endif %}

    <div class="notes-section">
        <h3>Notes</h3>
        {% for note in idea.notes %}
        <div class="note {% if note.user_id == current_user.id %}note-own{% endif %}">
            <p>{{ note.content }}</p>
            <div class="note-author">
                Added by {{ note.user.username }} 
                {% if note.user_id == current_user.id %}(You){% endif %}
                on {{ note.created_at.strftime('%Y-%m-%d %H:%M') }}
            </div>
        </div>
        {% endfor %}
        <form method="POST" action="{{ url_for('add_note', idea_id=idea.id) }}">
            <input type="text" name="note_content" placeholder="Add a note...">
            <button type="submit">Add Note</button>
        </form>
    </div>

    <div class="unified-comments-section">
        <div class="comments-header">
            <h3>Comments</h3>
        </div>
        
        <div class="comments-wrapper">
            <form class="comment-form" action="{{ url_for('add_comment', idea_id=idea.id) }}" method="POST">
                <textarea name="comment_content" placeholder="Add a comment..." required></textarea>
                <button type="submit">Post Comment</button>
            </form>

            <div class="comments-container">
                {% macro render_comment_thread(comment_data, level=0) %}
                <div class="comment-thread" style="margin-left: {{ level * 20 }}px;">
                    <div class="comment" id="comment-{{ comment_data.comment.id }}">
                        <div class="comment-content">{{ comment_data.comment.content }}</div>
                        <div class="comment-metadata">
                            <span class="comment-author">{{ comment_data.comment.user.username }}</span>
                            <span class="comment-date">{{ comment_data.comment.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                            
                            <button class="like-button {% if comment_data.comment.likes.filter_by(user_id=current_user.id).first() %}liked{% endif %}"
                                    onclick="toggleLike({{ comment_data.comment.id }})">
                                <i class="fas fa-dollar-sign {% if comment_data.comment.likes.filter_by(user_id=current_user.id).first() %}fas{% else %}far{% endif %}"></i>
                                <span class="like-count">{{ comment_data.comment.likes.count() }}</span>
                            </button>
                            
                            <button class="reply-button" onclick="toggleReplyForm({{ comment_data.comment.id }})">Reply</button>
                            
                            {% if current_user.id == comment_data.comment.user_id %}
                            <button class="edit-button" onclick="toggleEditForm({{ comment_data.comment.id }})">Edit</button>
                            <button class="delete-button" onclick="deleteComment({{ comment_data.comment.id }})">Delete</button>
                            {% endif %}
                        </div>

                        <div id="edit-form-{{ comment_data.comment.id }}" class="edit-form" style="display: none;">
                            <textarea>{{ comment_data.comment.content }}</textarea>
                            <div class="edit-actions">
                                <button onclick="submitEdit({{ comment_data.comment.id }})">Save</button>
                                <button onclick="toggleEditForm({{ comment_data.comment.id }})" class="cancel-button">Cancel</button>
                            </div>
                        </div>

                        <div id="reply-form-{{ comment_data.comment.id }}" class="reply-form" style="display: none;">
                            <textarea placeholder="Write your reply..."></textarea>
                            <div class="reply-actions">
                                <button onclick="submitReply({{ idea.id }}, {{ comment_data.comment.id }})">Submit</button>
                                <button onclick="toggleReplyForm({{ comment_data.comment.id }})" class="cancel-button">Cancel</button>
                            </div>
                        </div>
                    </div>

                    {% for reply in comment_data.replies %}
                        {{ render_comment_thread(reply, level + 1) }}
                    {% endfor %}
                </div>
                {% endmacro %}

                {% for comment_data in root_comments %}
                    {{ render_comment_thread(comment_data) }}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
function toggleReplyForm(commentId) {
    const replyForm = document.getElementById(`reply-form-${commentId}`);
    replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
}

async function submitReply(ideaId, parentId) {
    const replyForm = document.getElementById(`reply-form-${parentId}`);
    const content = replyForm.querySelector('textarea').value;
    
    try {
        const response = await fetch(`/add_reply/${ideaId}/${parentId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `content=${encodeURIComponent(content)}`
        });
        
        if (response.ok) {
            location.reload(); // Refresh to show new reply
        } else {
            alert('Failed to post reply');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to post reply');
    }
}

function toggleEditForm(commentId) {
    const editForm = document.getElementById(`edit-form-${commentId}`);
    editForm.style.display = editForm.style.display === 'none' ? 'block' : 'none';
}

async function submitEdit(commentId) {
    const editForm = document.getElementById(`edit-form-${commentId}`);
    const content = editForm.querySelector('textarea').value;
    
    try {
        const response = await fetch(`/edit_comment/${commentId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `content=${encodeURIComponent(content)}`
        });
        
        if (response.ok) {
            const data = await response.json();
            const comment = document.getElementById(`comment-${commentId}`);
            comment.querySelector('.comment-content').textContent = data.content;
            toggleEditForm(commentId);
        } else {
            alert('Failed to edit comment');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to edit comment');
    }
}

async function deleteComment(commentId) {
    if (!confirm('Are you sure you want to delete this comment?')) {
        return;
    }
    
    try {
        const response = await fetch(`/delete_comment/${commentId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const comment = document.getElementById(`comment-${commentId}`);
            comment.parentElement.remove();
        } else {
            alert('Failed to delete comment');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to delete comment');
    }
}

async function toggleLike(commentId) {
    try {
        const response = await fetch(`/toggle_like/${commentId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const data = await response.json();
            const likeButton = document.querySelector(`#comment-${commentId} .like-button`);
            const heartIcon = likeButton.querySelector('i');
            const likeCount = likeButton.querySelector('.like-count');
            
            if (data.liked) {
                likeButton.classList.add('liked');
                heartIcon.classList.remove('far');
                heartIcon.classList.add('fas');
            } else {
                likeButton.classList.remove('liked');
                heartIcon.classList.remove('fas');
                heartIcon.classList.add('far');
            }
            
            likeCount.textContent = data.count;
        }
    } catch (error) {
        console.error('Error:', error);
    }
}
</script>
{% endblock %} 